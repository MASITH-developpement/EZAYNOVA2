<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Action serveur pour créer une intervention à partir d'un email reçu -->
        <record id="action_server_create_intervention_from_mail" model="ir.actions.server">
            <field name="name">Créer intervention depuis email reçu</field>
            <field name="model_id" ref="mail.model_mail_message"/>
            <field name="state">code</field>
            <field name="code">
# Vérifier si c'est un email et s'il correspond à une configuration
if record.message_type == 'email':
    email_from = record.email_from.lower() if record.email_from else ''
    mail_config = env['intervention.mail.config'].sudo().search([
        ('email', '=ilike', email_from),
        ('active', '=', True),
        '|', ('company_id', '=', env.company.id), ('company_id', '=', False)
    ], limit=1)
    
    if mail_config:
        # Créer l'intervention avec le donneur d'ordre configuré
        intervention_vals = {
            'statut': 'planifie',
            'description': record.subject or "Email sans sujet",
            'donneur_ordre_id': mail_config.donneur_ordre_id.id,
        }

        # Créer l'intervention
        try:
            intervention = env['intervention.intervention'].sudo().create(intervention_vals)

            # Créer une activité pour planifier le RDV
            activity_type = env.ref('mail.mail_activity_data_todo', raise_if_not_found=False)
            
            # Assigner à l'utilisateur contact@stephane-moreau.fr
            scheduler_user = env['res.users'].sudo().search([('email', '=', 'contact@stephane-moreau.fr')], limit=1)
            if scheduler_user and intervention:
                env['mail.activity'].sudo().create({
                    'res_model_id': env['ir.model']._get('intervention.intervention').id,
                    'res_id': intervention.id,
                    'activity_type_id': activity_type.id if activity_type else False,
                    'summary': f"Planifier RDV - Nouvelle intervention {intervention.numero}",
                    'user_id': scheduler_user.id,
                    'date_deadline': (datetime.datetime.now() + datetime.timedelta(days=2)).strftime('%Y-%m-%d'),
                    'note': f"Email reçu de {record.email_from} ({mail_config.donneur_ordre_id.name}).\nSujet: {record.subject}\n\nMerci de planifier un rendez-vous.",
                })

                # Attacher le mail original à l'intervention et poster un message
                intervention.sudo().message_post(
                    body=record.body,
                    subject=record.subject,
                    message_type='email',
                    subtype_id=env.ref('mail.mt_comment').id,
                    email_from=record.email_from,
                )
                
                intervention.sudo().message_post(
                    body=f"Intervention créée automatiquement depuis l'email de {mail_config.email} (donneur d'ordre : {mail_config.donneur_ordre_id.name})",
                    message_type='notification'
                )

        except Exception as e:
            env['ir.logging'].sudo().create({
                'name': 'intervention.create.incoming',
                'type': 'server',
                'level': 'ERROR',
                'message': f'Erreur lors de la création de l\'intervention depuis l\'email: {str(e)}'
            })
            </field>
        </record>

        <!-- Règle d'automatisation : déclencher sur réception d'email -->
        <record id="automation_incoming_mail_create_intervention" model="base.automation">
            <field name="name">Créer intervention sur réception email</field>
            <field name="model_id" ref="mail.model_mail_message"/>
            <field name="trigger">on_create</field>
            <field name="filter_domain">[('message_type','=','email')]</field>
            <field name="action_server_ids" eval="[(4, ref('action_server_create_intervention_from_mail'))]"/>
            <field name="active">True</field>
        </record>

    </data>
</odoo>
